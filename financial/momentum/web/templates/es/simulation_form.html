{% extends "es/layout.html" %}

{% block content %}
<div class="card sim-form">
  <h2>Simulación de Cartera</h2>
  <p style="text-align:center;color:#6b7280;margin-top:0;">Configura las fechas, los activos y  el modelo para la simulación.</p>

  <form method="POST" action="">
    <div class="form-grid">
      <!-- Años -->
      <div>
        <label for="start_year">Año de inicio</label>
        <input type="number" name="start_year" id="start_year" value="2020" required>
      </div>
      <div>
        <label for="end_year">Año de fin</label>
        <input type="number" name="end_year" id="end_year" value="2024" required>
      </div>

      <!-- Universo -->
      <div>
        <label for="tickers">Tickers para la simulación</label>
        <select name="tickers" id="tickers" multiple size="10" required>
          {% for ticker in tickers %}
            <option value="{{ ticker }}">{{ ticker }}</option>
          {% endfor %}
        </select>
        <small class="help">Selecciona uno o varios</small>
      </div>

      <!-- Modelo + extras -->
      <div>
        <label for="architecture">Modelo (arquitectura)</label>
        <select name="architecture" id="architecture" required>
          <optgroup label="Deep Learning (Keras)">
            <option value="cnn">cnn</option>
            <option value="lstm">lstm</option>
            <option value="rnn">rnn</option>
            <option value="cnn2d">cnn2d</option>
          </optgroup>
          <optgroup label="Machine Learning (scikit-learn)">
            <option value="svr">svr</option>
            <option value="randomforest">randomforest</option>
          </optgroup> 
        </select>

        <div style="margin-top:12px;">
          <label for="extra_tickers">Tickers extra (para el modelo)</label>
          <select name="extra_tickers" id="extra_tickers" multiple size="6">
            <option value="" selected>Ninguno</option>
          </select>
          <small class="help">Para ML (svr, randomforest) no aplica y se usa “Ninguno”.</small>
          <div id="extra-summary" class="chips" aria-live="polite"></div>
        </div>
      </div>

      <!-- Tamaño cartera + refugio -->
      <div>
        <label for="num_assets">Número de activos en cartera</label>
        <input type="number" name="num_assets" id="num_assets" value="4" min="1" required>
      </div>
      <div>
        <label for="refuge">Activo refugio (opcional)</label>
        <select name="refuge" id="refuge">
          <option value="">Ninguno</option>
          <option value="GLD">Oro</option>
          <option value="^TNX">Bono USA 10 años</option>
        </select>
      </div>

      <!-- Botones -->
      <div class="full actions">
        <button type="button" class="btn btn-secondary" id="clearBtn">Limpiar</button>
        <button type="submit" class="btn btn-primary">Ejecutar simulación</button>
      </div>
    </div>
  </form>
</div>

<script>
const archSelect  = document.getElementById('architecture');
const extraSelect = document.getElementById('extra_tickers');
const extraSum    = document.getElementById('extra-summary');
const clearBtn    = document.getElementById('clearBtn');

function setExtrasDisabled(disabled){
  extraSelect.disabled = disabled;
  if(disabled){
    extraSelect.innerHTML = '<option value="" selected>Ninguno</option>';
    renderChips([]);
  }
}
function renderChips(values){
  extraSum.innerHTML = '';
  values.filter(v => v).forEach(v=>{
    const chip = document.createElement('span');
    chip.className='chip'; chip.textContent=v;
    extraSum.appendChild(chip);
  });
}
async function loadExtrasForArch(arch){
  if(arch==='svr' || arch==='randomforest'){ setExtrasDisabled(true); return; }
  setExtrasDisabled(false);
  try{
    const resp = await fetch(`/{{ lang }}/simulacion/api/extras?arch=${encodeURIComponent(arch)}`);
    const data = await resp.json(); // { extras: [...] }
    const opts = ['<option value="" selected>Ninguno</option>'];
    for(const e of (data.extras||[])){ opts.push(`<option value="${e}">${e}</option>`); }
    extraSelect.innerHTML = opts.join('');
    renderChips([]);
  }catch(e){
    console.error('Error cargando extras', e);
    extraSelect.innerHTML = '<option value="" selected>Ninguno</option>';
    renderChips([]);
  }
}
loadExtrasForArch(archSelect.value);
archSelect.addEventListener('change', ()=>loadExtrasForArch(archSelect.value));
extraSelect.addEventListener('change', ()=>{
  const vals = Array.from(extraSelect.selectedOptions).map(o=>o.value).filter(Boolean);
  renderChips(vals);
});
clearBtn.addEventListener('click', ()=>{
  document.getElementById('start_year').value = 2020;
  document.getElementById('end_year').value = 2025;
  document.getElementById('tickers').selectedIndex = -1;
  document.getElementById('num_assets').value = 4;
  document.getElementById('refuge').value = '';
  loadExtrasForArch(archSelect.value);
});
</script>
{% endblock %}
