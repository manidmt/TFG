{% extends "es/layout.html" %}

{% block content %}
<div class="card sim-form">
  <h2>Simulación de Cartera</h2>
  <p style="text-align:center;color:#6b7280;margin-top:0;">Configura las fechas, los activos y  el modelo para la simulación.</p>

  <form method="POST" action="">
    <div class="form-grid">
      <!-- Años -->
      <div>
        <label for="start_year">Año de inicio</label>
        <input type="number" name="start_year" id="start_year" value="2020" required>
      </div>
      <div>
        <label for="end_year">Año de fin</label>
        <input type="number" name="end_year" id="end_year" value="2025" required>
      </div>

      <!-- Universo -->
      <div>
        <label for="tickers">Tickers para la simulación</label>
        <select name="tickers" id="tickers" multiple size="10" required>
          {% for ticker in tickers %}
            <option value="{{ ticker }}">{{ ticker }}</option>
          {% endfor %}
        </select>
        <small class="help">Selecciona uno o varios</small>
      </div>

      <!-- Modelo + extras -->
      <div>
        <label for="architecture">Modelo (arquitectura)</label>
        <select name="architecture" id="architecture" required>
          <optgroup label="Deep Learning (Keras)">
            <option value="cnn">cnn</option>
            <option value="lstm">lstm</option>
            <option value="rnn">rnn</option>
            <option value="cnn2d">cnn2d</option>
          </optgroup>
          <optgroup label="Machine Learning (scikit-learn)">
            <option value="svr">svr</option>
            <option value="randomforest">randomforest</option>
          </optgroup> 
        </select>

        <div style="margin-top:12px;">
          <label for="extra_ticker">Ticker extra (para el modelo)</label>
          <select name="extra_ticker" id="extra_tickers">
            <option value="">Ninguno</option>
          </select>
          <small class="help">Para ML (svr, randomforest) no aplica y se usa “Ninguno”.</small>
        </div>
      </div>

      <!-- Tamaño cartera + refugio -->
      <div>
        <label for="num_assets">Número de activos en cartera</label>
        <input type="number" name="num_assets" id="num_assets" value="4" min="1" required>
      </div>
      <div>
        <label for="refuge">Activo refugio (opcional)</label>
        <select name="refuge" id="refuge">
          <option value="">Ninguno</option>
          <option value="GLD">Oro</option>
          <option value="^TNX">Bono USA 10 años</option>
        </select>
      </div>

      <!-- Botones -->
      <div class="full actions">
        <button type="button" class="btn btn-secondary" id="clearBtn">Limpiar</button>
        <button type="submit" class="btn btn-primary">Ejecutar simulación</button>
      </div>
    </div>
  </form>
</div>

<script>
const archSelect  = document.getElementById('architecture');
const extraSelect = document.getElementById('extra_tickers');
const clearBtn    = document.getElementById('clearBtn');

function disableExtras(disabled){
  extraSelect.disabled = disabled;
  if(disabled){
    extraSelect.innerHTML = '<option value="">Ninguno</option>';
  }
}

async function loadExtrasForArch(arch){
  if(arch==='svr' || arch==='randomforest'){ disableExtras(true); return; }
  disableExtras(false);
  try{
    const resp  = await fetch(`/{{ lang }}/simulacion/api/extras?arch=${encodeURIComponent(arch)}`);
    const data  = await resp.json(); // { extras: [...] }
    const opts  = ['<option value="">Ninguno</option>'];
    for(const e of (data.extras||[])){ opts.push(`<option value="${e}">${e}</option>`); }
    extraSelect.innerHTML = opts.join('');
  }catch(e){
    console.error('Error cargando extras', e);
    extraSelect.innerHTML = '<option value="">Ninguno</option>';
  }
}

archSelect.addEventListener('change', ()=>loadExtrasForArch(archSelect.value));

clearBtn.addEventListener('click', ()=>{
  document.getElementById('start_year').value = 2020;
  document.getElementById('end_year').value = 2025;
  document.getElementById('tickers').selectedIndex = -1;
  document.getElementById('num_assets').value = 4;
  document.getElementById('refuge').value = '';
  extraSelect.value = '';
  loadExtrasForArch(archSelect.value);  
});

loadExtrasForArch(archSelect.value);
</script>
{% endblock %}

{% block helptext %}
  <h4>Configuración de la simulación</h4>
  <p>
    Aquí se establecen los parámetros para hacer una simulación de la cartera en función de los parámetros:
  </p>
  <ul>
    <li><strong>Año de inicio:</strong> Año de inicio para la simulación.</li>
    <li><strong>Año de fin:</strong> Año de fin para la simulación.</li>
    <li><strong>Modelo:</strong> Modelo que se utilizará para la simulación.</li>
    <li><strong>Tickers:</strong> Activos que se tienen en cuenta para crear la cartera. Usa Ctrl/Shift + Click para seleccionar varios</li>
    <li><strong>Tickers extra:</strong> Activos adicionales que el modelo puede usar para mejorar la predicción (solo para modelos Keras).</li>
    <li><strong>Número de activos:</strong> Cuántos activos habrá en la cartera en cada momento.</li>
    <li><strong>Activo refugio:</strong> Activo refugio opcional para la cartera.</li>
  </ul>
  <p>
    Para más información, recomiendo consultar la sección correspondiente en la memoria del TFG (tienes el link ahí abajo).
  </p>
{% endblock %}
